const express = require("express");
const cors = require("cors");

// Your Twilio credentials (direct use)
const twilio = require("twilio")(
  "AC0aa790a3a762d1b4f9329942c229712c",
  "677b573cc95c5b67bd1e5f6535a051a3"
);

const app = express();
app.use(cors());
app.use(express.json());

// Miner numbers
const minerNumbers = [
  "+917416013923",
  "+919032017652",
  "+918074540124",
  "+916302954663",
  "+918885648652",
  "+918919125074"
];

// TwiML endpoint: serves voice instructions when call connects
app.all("/voice", (req, res) => {
  res.type("text/xml");
  res.send(`<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Play>https://files.catbox.moe/5tnq6i.mp3</Play>
</Response>`);
});

// Test endpoint with TTS (doesn't need external files)
app.all("/voice-test", (req, res) => {
  res.type("text/xml");
  res.send(`<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Say language="hi-IN">рдЦрд╛рдиреЛрдВ рдореЗрдВ рдЙрдЪрд┐рдд рд╡реЗрдВрдЯреАрд▓реЗрд╢рди рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рд╣реЛрдирд╛ рдмрд╣реБрдд рдЬрд░реВрд░реА рд╣реИ, рдЬреЛ рд╣рд╡рд╛ рдХреЛ рд╕рд╛рдл рд░рдЦрддрд╛ рд╣реИ рдФрд░ рд╣рд╛рдирд┐рдХрд╛рд░рдХ рдЧреИрд╕реЛрдВ рдХреЛ рдмрд╛рд╣рд░ рдирд┐рдХрд╛рд▓рддрд╛ рд╣реИред рдпрд╣ рд╡реЗрдВрдЯреАрд▓реЗрд╢рди рдлреИрди рддрд╛рдЬреА рд╣рд╡рд╛ рдХреЛ рдЕрдВрджрд░ рдЦреАрдВрдЪрддрд╛ рд╣реИ рдФрд░ рджреВрд╖рд┐рдд рд╣рд╡рд╛ рдХреЛ рдмрд╛рд╣рд░ рдлреЗрдВрдХрддрд╛ рд╣реИред рдЦрддрд░рдирд╛рдХ рдЧреИрд╕реЛрдВ рдЬреИрд╕реЗ рдореАрдереЗрди рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЧреИрд╕ рдбрд┐рдЯреЗрдХреНрдЯрд░реЛрдВ рдХрд╛ рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред рд╡реЗрдВрдЯреАрд▓реЗрд╢рди рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдХрд┐рд╕реА рднреА рддрд░рд╣ рдХреА рд░реБрдХрд╛рд╡рдЯ рдпрд╛ рдХреНрд╖рддрд┐ рдХреА рддреБрд░рдВрдд рд░рд┐рдкреЛрд░реНрдЯ рдХрд░реЗрдВред рд╡реЗрдВрдЯреАрд▓реЗрд╢рди рдкрд░реНрджреЛрдВ рдХреЛ рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рд▓рдЧрд╛рдирд╛ рдФрд░ рдмрдирд╛рдП рд░рдЦрдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рддрд╛рдХрд┐ рд╣рд╡рд╛ рд╕рд╣реА рджрд┐рд╢рд╛ рдореЗрдВ рдмрд╣реЗред рд╕реБрд░рдХреНрд╖рд┐рдд рдЦрдирди рдХреЗ рд▓рд┐рдП рд╣рдореЗрд╢рд╛ рдЙрдЪрд┐рдд рд╡реЗрдВрдЯреАрд▓реЗрд╢рди рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ рдФрд░ рдЕрдкрдиреЗ рд╕реНрд╡рд╛рд╕реНрдереНрдп рдХреА рд░рдХреНрд╖рд╛ рдХрд░реЗрдВред</Say>
</Response>`);
});

// API route: when safety officer clicks тЖТ calls selected miners
app.post("/alert", async (req, res) => {
  try {
    const { phoneNumbers, message } = req.body;
    
    // Use provided phone numbers or fall back to default miner list
    const numbersToCall = phoneNumbers && phoneNumbers.length > 0 
      ? phoneNumbers 
      : minerNumbers;
    
    console.log(`ЁЯУЮ Initiating calls to ${numbersToCall.length} miners...`);
    
    const twiml = `<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Say language="hi-IN">рдЦрд╛рдиреЛрдВ рдореЗрдВ рдЙрдЪрд┐рдд рд╡реЗрдВрдЯреАрд▓реЗрд╢рди рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рд╣реЛрдирд╛ рдмрд╣реБрдд рдЬрд░реВрд░реА рд╣реИ, рдЬреЛ рд╣рд╡рд╛ рдХреЛ рд╕рд╛рдл рд░рдЦрддрд╛ рд╣реИ рдФрд░ рд╣рд╛рдирд┐рдХрд╛рд░рдХ рдЧреИрд╕реЛрдВ рдХреЛ рдмрд╛рд╣рд░ рдирд┐рдХрд╛рд▓рддрд╛ рд╣реИред рдпрд╣ рд╡реЗрдВрдЯреАрд▓реЗрд╢рди рдлреИрди рддрд╛рдЬреА рд╣рд╡рд╛ рдХреЛ рдЕрдВрджрд░ рдЦреАрдВрдЪрддрд╛ рд╣реИ рдФрд░ рджреВрд╖рд┐рдд рд╣рд╡рд╛ рдХреЛ рдмрд╛рд╣рд░ рдлреЗрдВрдХрддрд╛ рд╣реИред рдЦрддрд░рдирд╛рдХ рдЧреИрд╕реЛрдВ рдЬреИрд╕реЗ рдореАрдереЗрди рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЧреИрд╕ рдбрд┐рдЯреЗрдХреНрдЯрд░реЛрдВ рдХрд╛ рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред рд╡реЗрдВрдЯреАрд▓реЗрд╢рди рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдХрд┐рд╕реА рднреА рддрд░рд╣ рдХреА рд░реБрдХрд╛рд╡рдЯ рдпрд╛ рдХреНрд╖рддрд┐ рдХреА рддреБрд░рдВрдд рд░рд┐рдкреЛрд░реНрдЯ рдХрд░реЗрдВред рд╡реЗрдВрдЯреАрд▓реЗрд╢рди рдкрд░реНрджреЛрдВ рдХреЛ рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рд▓рдЧрд╛рдирд╛ рдФрд░ рдмрдирд╛рдП рд░рдЦрдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рддрд╛рдХрд┐ рд╣рд╡рд╛ рд╕рд╣реА рджрд┐рд╢рд╛ рдореЗрдВ рдмрд╣реЗред рд╕реБрд░рдХреНрд╖рд┐рдд рдЦрдирди рдХреЗ рд▓рд┐рдП рд╣рдореЗрд╢рд╛ рдЙрдЪрд┐рдд рд╡реЗрдВрдЯреАрд▓реЗрд╢рди рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ рдФрд░ рдЕрдкрдиреЗ рд╕реНрд╡рд╛рд╕реНрдереНрдп рдХреА рд░рдХреНрд╖рд╛ рдХрд░реЗрдВред</Say>
</Response>`;
    
    const promises = numbersToCall.map(number => {
      console.log(`  ЁЯУ▒ Calling: ${number}`);
      return twilio.calls.create({
        to: number,
        from: "+1 484 371 5640",
        twiml: twiml,
      });
    });
    
    const results = await Promise.all(promises);
    console.log(`тЬЕ Successfully initiated ${results.length} calls`);
    
    res.json({ 
      message: `Alert calls sent to ${results.length} miner(s)!`,
      count: results.length,
      callSids: results.map(r => r.sid)
    });
  } catch (error) {
    console.error("тЭМ Call error:", error);
    res.status(500).json({ error: error.message });
  }
});

// Start backend server
app.listen(5000, () => {
  console.log("Server running at http://localhost:5000");
});
