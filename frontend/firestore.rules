rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- 1️⃣ TEST MODE SUPPORT (open access until expiration date) ---
    function isTestMode() {
      return request.time < timestamp.date(2025, 12, 26);
    }

    // --- 2️⃣ NORMAL AUTHENTICATED MODE SUPPORT ---
    function isLoggedIn() {
      return request.auth != null;
    }

    // --- USERS COLLECTION ---
    match /users/{userId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → allow authenticated users to read
      allow read: if isLoggedIn();

      // User can write only their own user document
      allow write: if isLoggedIn() && request.auth.uid == userId;
    }

    // --- INCIDENTS COLLECTION ---
    match /incidents/{incidentId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read/write incidents
      allow read, write: if isLoggedIn();
    }

    // --- VIDEO LIBRARY COLLECTION (will be created on first write) ---
    match /videoLibrary/{videoId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read all videos
      allow read: if isLoggedIn();

      // Safety officers and supervisors can create/update/delete videos
      allow write: if isLoggedIn();
    }

    // --- VIDEO ASSIGNMENTS COLLECTION ---
    match /videoAssignments/{assignmentId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read/write assignments
      allow read, write: if isLoggedIn();
    }

    // --- POSTS COLLECTION (Reels, Photos, Videos uploaded by miners) ---
    match /posts/{postId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read all posts
      allow read: if isLoggedIn();

      // Users can create posts
      allow create: if isLoggedIn();

      // Users can update/delete only their own posts
      allow update, delete: if isLoggedIn() && request.auth.uid == resource.data.userId;
    }

    // --- ASSIGNMENT PROGRESS COLLECTION ---
    match /assignmentProgress/{progressId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can track their progress
      allow read, write: if isLoggedIn();
    }

    // --- VIDEO ANALYTICS COLLECTION ---
    match /videoAnalytics/{analyticsId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read/write analytics
      allow read, write: if isLoggedIn();
    }

    // --- VIDEO REQUESTS COLLECTION ---
    match /videoRequests/{requestId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read/write requests
      allow read, write: if isLoggedIn();
    }

    // --- WORK ASSIGNMENTS COLLECTION (Smart Work Assignment feature) ---
    match /workAssignments/{assignmentId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read/write work assignments
      allow read, write: if isLoggedIn();
    }

    // --- NOTIFICATIONS COLLECTION ---
    match /notifications/{notificationId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → users can read their own notifications, supervisors can create notifications
      allow read: if isLoggedIn();
      allow write: if isLoggedIn();
    }

    // --- HAZARDS COLLECTION (Manual hazards) ---
    match /hazards/{hazardId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read hazards
      allow read: if isLoggedIn();

      // Safety officers can create/update/delete hazards
      allow write: if isLoggedIn();
    }

    // --- ML HAZARDS COLLECTION (AI-detected hazards) ---
    match /mlHazards/{mlHazardId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read ML hazards
      allow read: if isLoggedIn();

      // System/Backend can write ML hazards
      allow write: if isLoggedIn();
    }

    // --- MINERS COLLECTION (Live miner locations) ---
    match /miners/{minerId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read miner data
      allow read: if isLoggedIn();

      // Safety officers and miners themselves can update
      allow write: if isLoggedIn();
    }

    // --- EQUIPMENT HAZARDS COLLECTION ---
    match /equipmentHazards/{equipmentId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read equipment hazards
      allow read: if isLoggedIn();

      // Safety officers can create/update equipment hazards
      allow write: if isLoggedIn();
    }

    // --- MAP CONFIG COLLECTION ---
    match /mapConfig/{mapId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read map config
      allow read: if isLoggedIn();

      // Only admins/safety officers can update map config
      allow write: if isLoggedIn();
    }

    // --- HAZARD ZONES COLLECTION ---
    match /hazardZones/{zoneId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read hazard zones
      allow read: if isLoggedIn();

      // Safety officers can update zones
      allow write: if isLoggedIn();
    }

    // --- PPE SCANS COLLECTION ---
    match /ppeScans/{scanId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read/write PPE scans
      allow read, write: if isLoggedIn();
    }

    // --- PPE CONFIGS COLLECTION ---
    match /ppeConfigs/{configId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read PPE configs
      allow read: if isLoggedIn();

      // Safety officers can update configs
      allow write: if isLoggedIn();
    }

    // --- DAILY QUIZZES COLLECTION ---
    match /dailyQuizzes/{quizId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read quizzes
      allow read: if isLoggedIn();

      // Safety officers can create/update/delete quizzes
      allow write: if isLoggedIn();
    }

    // --- QUIZ RESPONSES COLLECTION ---
    match /quizResponses/{responseId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode → authenticated users can read/write quiz responses
      allow read, write: if isLoggedIn();
    }

    // --- TESTIMONIALS COLLECTION ---
    match /testimonials/{testimonialId} {
      // Test Mode → allow all
      allow read, write: if isTestMode();

      // Normal Mode:
      // - Approved testimonials can be read by anyone authenticated
      // - Miners can create testimonials (status: pending)
      // - Users can read their own testimonials (any status)
      // - Safety officers can update testimonial status (approve/reject)
      allow read: if isLoggedIn() && (
        resource.data.status == 'approved' ||
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'safety_officer'
      );
      
      allow create: if isLoggedIn();
      
      allow update: if isLoggedIn() && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'safety_officer'
      );
    }

    // --- FALLBACK: deny everything else ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
